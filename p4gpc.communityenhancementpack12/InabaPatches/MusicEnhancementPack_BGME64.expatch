var battleBgms(1) = bytes(00)
var randomSongs(12) = bytes(A702A902A902AB02AB02AD02)
var encounterMusic(7552) = bytes(0201230001000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000001012300AD02000001012300AD02000001012300AD02000001012300AD02000001012300AD02000001012300AD02000001012300AD02000001012300AD02000001012300AD02000001012300AD02000001012300AD02000001012300AD0200000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000001012300AD0200000201230000000000020123000000000001012300AD020000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000001012300AD02000001012300AD02000001012300AD02000001012300AD02000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000001012300AD02000001012300AD02000001012300AD02000001012300AD02000001012300AD02000001012300AD02000001012300AD020000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000100000002012300010000000201230001000000020123000100000002012300010000000201230001000000020123000100000002012300010000000201230001000000020123000100000002012300010000000201230001000000020123000100000002012300010000000201230001000000020123000100000002012300000000000201230001000000020123000100000002012300010000000201230001000000020123000100000002012300010000000201230001000000020123000100000002012300010000000201230001000000020123000100000002012300010000000201230001000000020123000000000002012300010000000201230001000000020123000100000002012300010000000201230001000000020123000100000002012300010000000201230000000000020123000100000002012300010000000201230001000000020123000100000002012300010000000201230001000000020123000100000002012300010000000201230001000000020123000100000002012300000000000201230001000000020123000100000002012300010000000201230001000000020123000100000002012300010000000201230001000000020123000100000002012300010000000201230001000000020123000100000002012300010000000201230001000000020123000100000002012300000000000201230001000000020123000100000002012300010000000201230001000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000000123000200000000012300020000000001230002000000000123000200000000012300020000000001230002000000000123000B0000000001230002000000000123000300000001012300B30200000001230006000000000123000400000001012300B202000001012300B402000001012300B102000001012300B102000001012300B1020000010123005100000001012300B102000001012300B102000000012300070000000001230008000000000123000D000000010123004E00000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000200000002012300020000000201230002000000020123000200000002012300020000000201230002000000020123000200000002012300020000000201230002000000020123000200000002012300020000000201230002000000020123000200000002012300020000000201230002000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000001012300AD02000001012300AD02000001012300AD02000001012300AD02000001012300AD0200000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000001012300AE02000001012300AE02000001012300AE02000001012300AE02000001012300AE02000001012300AE02000001012300AE02000001012300AE02000001012300AE02000001012300AE02000001012300AF02000001012300AF02000001012300AF02000001012300AA02000001012300AF02000001012300AF02000001012300AF02000001012300AF02000001012300AF02000001012300AF020000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230002000000020123000200000002012300020000000201230002000000020123000200000002012300020000000201230002000000020123000200000002012300020000000201230000000000020123000200000002012300020000000201230002000000020123000200000002012300020000000201230002000000020123000200000002012300020000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230000000000020123000000000002012300000000000201230002000000020123000200000002012300020000000201230002000000020123000200000002012300020000000201230000000000020123000200000002012300020000000201230002000000020123000200000002012300020000000201230002000000020123000000000001012300AD02000001012300AD02000002012300000000000201230002000000020123000200000002012300020000000201230002000000020123000200000002012300020000000201230000000000020123000200000002012300020000000201230002000000020123000200000002012300020000000201230002000000020123000200000002012300020000000201230000000000020123000200000002012300020000000201230002000000020123000200000002012300020000000201230002000000020123000200000002012300000000000201230002000000020123000200000002012300020000000201230002000000020123000200000002012300020000000201230002000000020123000000000002012300020000000201230002000000020123000200000002012300020000000201230002000000020123000200000002012300020000000201230002000000020123000000000001012300B002000001012300B00200000201230002000000020123000200000002012300000000000201230000000000)
var tvBgms(358) = bytes(370037003700370037003700380038003800380038003800380038003800380038003800380038003700390039003900390039003900390039003900390039003900390039003900390039003900390037003A003A003A003A003A003A003A003A003A003A003A003A003A003A003A003A003A003A003A0037003B003B003B003B003B003B003B003B003B003B003B003B003B003B003B003B003B003B003B0037003C003C003C003C003C003C003C003C003C003C003C003C003C003C003C003C003C003C003C0037003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D0037003E003E003E003E003E003E003E003E003E003E003E003E003E003E003E003E003E003E003E0037003F003F003F003F003F003F003F003F003F003F003F003F003F003F003F003F003F003F001C0037001C001C001C001C001C001C001C001C001C001C001C001C001C001C001C001C001C001C00)
//var battleBgms(8) = bytes(00)
//var randomSongs(1) = bytes(00)
//var encounterMusic(7552) = bytes(0000000000000000)
const RANDOM_SONG_SIZE = 4
const BATTLE_BGM_SIZE = 8
const WAVEFORM_ENTRY_SIZE = 20
const SONG_CUE_INDEX_1 = 58
const SONG_AWB_INDEX_1 = 80
const SONG_WAVEFORM_INDEX_1 = 57
const SONG_CUE_INDEX_2 = 61
const SONG_AWB_INDEX_2 = 82
const SONG_TABLE_INDEX_2 = 60
const VICTORY_CUE_INDEX = 7
const VICTORY_AWB_INDEX = 35
const VICTORY_TABLE_INDEX = 7
var currentPass(1) = 0
var battleCtxBgmType(1) = bytes(00)
[patch BGME - Encounter BGM]
pattern = 0F B7 4C D0 16
mov rax, {encounterMusic}
mov rdx, rcx
label start
mov r12, {currentPass}
cmp byte [r12], 0
movzx ecx, word [rax + rdx * 0x8 + 2]
movzx r12, byte [rax + rdx * 0x8 + 1]
je victoryMusicPass
movzx ecx, word [rax + rdx * 0x8 + 4]
movzx r12, byte [rax + rdx * 0x8]
label victoryMusicPass
label setupMusic
mov r13, {battleCtxBgmType}
cmp byte [r13], 0
je setupSong
movzx r12, byte [r13]
mov byte [r13], 0
label setupSong
cmp r12, 0
je bgmeOff
cmp r12, 3
jl randomSong
push rax
push rdx
mov rax, rcx
mov r12w, {BATTLE_BGM_SIZE}
mul r12w
mov r12, {battleBgms}
add r12, rax
movzx rax, word [r8 + 0x1e]
mov r13w, word [r12]
cmp rax, 2
je configReady
shr r13w, 2
cmp rax, 1
je configReady
shr r13w, 2
label configReady
and r13, 3
mov r14, {battleCtxBgmType}
mov byte [r14], r13b
mov r14, 2
mul r14
movzx r12d, word [r12 + rax + 2]
mov ecx, r12d
pop rdx
pop rax
jmp setupMusic
label randomSong
cmp r12, 2
jl playSong
push rax
push rdx
mov rax, {RANDOM_SONG_SIZE}
mul ecx
mov r12, {randomSongs}
add r12, rax
mov r13w, [r12 + 2]
mov r12w, [r12]
sub r13w, r12w
mov rax, 0x1451FE644
mov rax, [rax]
xor rdx, rdx
div r13w
add r12w, dx
movzx ecx, r12w
pop rdx
pop rax
label playSong
mov r9, 0x140BEAB30
mov r9, [r9]
mov r9, [r9 + 0x18]
add r9, 0xAF77
mov r12, {currentPass}
cmp byte [r12], 0
jne encounterPass
add r9, {VICTORY_TABLE_INDEX} * {WAVEFORM_ENTRY_SIZE}
xchg cl, ch
mov [r9 + 16], cx
mov byte [r12], 1
jmp start
label encounterPass
mov r12, {currentPass}
mov byte [r12], 0
add r9, {SONG_WAVEFORM_INDEX_1} * {WAVEFORM_ENTRY_SIZE}
xchg cl, ch
mov [r9 + 16], cx
mov edx, {SONG_CUE_INDEX_1}
mov r9, 0x1400bc6fd
jmp r9
label bgmeOff
mov r12, {currentPass}
mov byte [r12], 0
add ecx, -2
